#!/usr/bin/bash

exec 3<$HOME/.claude.json

# Build extra --ro-bind args for paths outside $PWD that bwrap would otherwise miss.
extra_binds=()
declare -A seen_binds

# If .git is a file we're in a worktree. Bind the main repo's .git common dir
# so git operations work (objects, refs, etc. all live there).
if [ -f "$PWD/.git" ]; then
    git_common_dir=$(git rev-parse --git-common-dir 2>/dev/null)
    if [ -n "$git_common_dir" ]; then
        git_common_dir=$(realpath "$git_common_dir")
        extra_binds+=(--ro-bind "$git_common_dir" "$git_common_dir")
        seen_binds[$git_common_dir]=1
    fi
fi

# Find symlinks under $PWD (skip node_modules for speed) whose resolved targets
# live outside $PWD, then ro-bind each unique target.
while IFS= read -r -d '' link; do
    target=$(realpath "$link" 2>/dev/null) || continue
    [[ "$target" == "$PWD"/* ]] && continue
    [ -z "${seen_binds[$target]}" ] || continue
    extra_binds+=(--ro-bind "$target" "$target")
    seen_binds[$target]=1
done < <(find "$PWD" -not -path "*/node_modules/*" -type l -print0 2>/dev/null)

exec /usr/bin/bwrap \
    --tmpfs /tmp \
    --dev /dev \
    --proc /proc \
    --hostname bubblewrap --unshare-uts \
    --ro-bind /bin /bin \
    --ro-bind /lib /lib \
    --ro-bind /lib32 /lib32 \
    --ro-bind /lib64 /lib64 \
    --ro-bind /usr/bin /usr/bin \
    --ro-bind /usr/lib /usr/lib \
    --ro-bind /usr/local/bin /usr/local/bin \
    --ro-bind /usr/local/lib /usr/local/lib \
    --ro-bind /usr/share/tesseract-ocr/5/tessdata/ /usr/share/tesseract-ocr/5/tessdata/ \
    --ro-bind /tmp/tmux-1002/ /tmp/tmux-1002/ \
    --ro-bind /etc/alternatives /etc/alternatives \
    --ro-bind /etc/resolv.conf /etc/resolv.conf \
    --ro-bind /etc/profile.d /etc/profile.d \
    --ro-bind /etc/bash_completion.d /etc/bash_completion.d \
    --ro-bind /etc/ssl/certs /etc/ssl/certs \
    --ro-bind /etc/ld.so.cache /etc/ld.so.cache \
    --ro-bind /etc/ld.so.conf /etc/ld.so.conf \
    --ro-bind /etc/ld.so.conf.d /etc/ld.so.conf.d \
    --ro-bind /etc/localtime /etc/localtime \
    --ro-bind /usr/share/terminfo /usr/share/terminfo \
    --ro-bind /usr/share/ca-certificates /usr/share/ca-certificates \
    --ro-bind /etc/nsswitch.conf /etc/nsswitch.conf \
    --ro-bind /etc/hosts /etc/hosts \
    --ro-bind /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf \
    --ro-bind /usr/share/zoneinfo /usr/share/zoneinfo \
    --ro-bind $HOME/.bashrc $HOME/.bashrc \
    --ro-bind $HOME/.profile $HOME/.profile \
    --ro-bind $HOME/.gitconfig $HOME/.gitconfig \
    --ro-bind $HOME/.local $HOME/.local \
    --ro-bind $HOME/.local/bin $HOME/.local/bin \
    --ro-bind $HOME/.cargo $HOME/.cargo \
    --ro-bind $HOME/.cargo/bin $HOME/.cargo/bin \
    --ro-bind $HOME/Downloads $HOME/Downloads \
    --ro-bind $HOME/.asdf $HOME/.asdf \
    --ro-bind $HOME/.tool-versions $HOME/.tool-versions \
    --bind $HOME/.claude $HOME/.claude \
    --bind $HOME/.cache $HOME/.cache \
    --file 3 $HOME/.claude.json \
    "${extra_binds[@]}" \
    --bind "$PWD" "$PWD" \
    claude --dangerously-skip-permissions $@

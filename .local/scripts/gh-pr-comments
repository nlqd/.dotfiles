#!/usr/bin/env bash

OUTPUT_JSON=false
if [[ "$1" == "--json" ]]; then
  OUTPUT_JSON=true
fi

read owner repo number < <(gh pr view --json headRepositoryOwner,headRepository,number -q '[.headRepositoryOwner.login, .headRepository.name, .number] | @tsv')

response=$(gh api graphql -f query='
  query($owner: String!, $repo: String!, $number: Int!) {
    repository(owner: $owner, name: $repo) {
      pullRequest(number: $number) {
        state
        merged
        mergeable
        mergeStateStatus
        baseRefName
        headRefName
        comments(first: 100) {
          nodes {
            id
            databaseId
            body
            author { login }
            createdAt
          }
        }
        latestReviews(first: 100) {
          nodes {
            author { login }
            state
            submittedAt
          }
        }
        reviewThreads(first: 100) {
          nodes {
            id
            isResolved
            resolvedBy { login }
            comments(first: 100) {
              nodes {
                id
                databaseId
                body
                author { login }
                createdAt
                path
                line
                diffHunk
                replyTo { id }
              }
            }
          }
        }
      }
    }
  }
' -f owner="$owner" -f repo="$repo" -F number="$number")

if $OUTPUT_JSON; then
  echo "$response" | jq '.data.repository.pullRequest | {
    state,
    merged,
    mergeable,
    mergeStateStatus,
    baseRefName,
    headRefName,
    reviews: .latestReviews.nodes,
    comments: [.comments.nodes[] | select(.author.login != "claude")],
    reviewThreads: .reviewThreads.nodes
  }'
  exit 0
fi

echo "$response" | jq -r --arg num "$number" '
.data.repository.pullRequest as $pr |
($pr.latestReviews.nodes | length) as $review_count |
[$pr.comments.nodes[] | select(.author.login != "claude")] as $conv |
[$pr.reviewThreads.nodes[] | select(.isResolved)] as $resolved |
[$pr.reviewThreads.nodes[] | select(.isResolved | not)] as $open |

"PR #\($num) \(if $pr.merged then "MERGED" elif $pr.state == "OPEN" then "OPEN" else "CLOSED" end)
\($pr.headRefName) â†’ \($pr.baseRefName)
Merge: \($pr.mergeStateStatus // "UNKNOWN") | Conflicts: \($pr.mergeable // "UNKNOWN")

REVIEWER        STATE               DATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
\(if $review_count == 0 then "  (no reviews yet)" else
  [$pr.latestReviews.nodes[] |
    "\(.author.login)\(" " * (15 - (.author.login | length))) \(
      if .state == "APPROVED" then "âœ“ APPROVED"
      elif .state == "CHANGES_REQUESTED" then "âœ— CHANGES_REQ"
      elif .state == "COMMENTED" then "ğŸ’¬ COMMENTED"
      elif .state == "DISMISSED" then "âŠ˜ DISMISSED"
      else .state end
    )\(" " * (19 - (
      if .state == "APPROVED" then 10
      elif .state == "CHANGES_REQUESTED" then 13
      elif .state == "COMMENTED" then 11
      elif .state == "DISMISSED" then 10
      else (.state | length) end
    ))) \(.submittedAt | split("T")[0])"
  ] | join("\n")
end)
\(if ($conv | length) > 0 then "
CONVERSATION COMMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
\([$conv[] |
  "@\(.author.login) [\(.databaseId)] \(.createdAt | split("T")[0])
  \(.body | gsub("\n"; "\n  "))
"] | join("\n"))
" else "" end)\(if ($resolved | length) > 0 then "
(\($resolved | length) resolved thread\(if ($resolved | length) > 1 then "s" else "" end))
" else "" end)\(if ($open | length) > 0 then "
OPEN REVIEW THREADS (\($open | length))
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
\([$open[] |
  "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
\(.comments.nodes[0].path // "(no file)")\(if .comments.nodes[0].line then ":\(.comments.nodes[0].line)" else "" end)

\([.comments.nodes[] |
  "\(if .replyTo then "â†³ " else "" end)@\(.author.login) [\(.databaseId)] \(.createdAt | split("T")[0])
  \(.body | gsub("\n"; "\n  "))\(
    if .diffHunk and .diffHunk != "" and (.replyTo | not) then "

  ```diff
  \(.diffHunk | gsub("\n"; "\n  "))
  ```" else "" end)
"] | join("\n\n"))"
] | join("\n\n"))
" else "" end)"
'

autoload -U compinit
compinit -i

plugins=(git systemd)

### envs
export ZSH="$HOME/.oh-my-zsh"

export KEYTIMEOUT=1

HISTSIZE=999999999
SAVEHIST=$HISTSIZE

export EDITOR=nvim
export MANPAGER='nvim +Man!'

PATH="$HOME/.asdf/shims:$PATH"
PATH="$HOME/.local/bin/:$PATH"
PATH="$HOME/.local/bin/statusbar-lukesmithxyz/:$PATH"
PATH="$HOME/.local/scripts:$PATH"
PATH="/usr/local/go/bin:$PATH"
PATH="$HOME/go/bin:$PATH"
PATH="$HOME/.foundry/bin:$PATH"
PATH="$HOME/flutter/bin:$PATH"
PATH="$HOME/.pub-cache/bin:$PATH"
# PATH="$HOME/Downloads/zips/platform-tools:$PATH"

export PATH

export DEV_HOME="$HOME/dev"

alias hr='heroku'
alias flatpak-flutter='docker run --rm -v "$PWD":/usr/src/flatpak -u `id -u`:`id -g` theappgineer/flatpak-flutter:latest'

alias upgrade='sudo apt update && sudo apt upgrade && sudo snap refresh && flatpak update -y'

alias v="nvim"
alias vv="nvim"
alias vg="nvim +G"
alias ez='nvim ~/.zshrc'
alias sz='source ~/.zshrc'
alias dot='nvim ~/Dev/personal/dotfiles'
alias ck='nvim ~/.sdai/cookies'
alias tma='tmux -2 a'
alias mkdir='mkdir -v'
alias lg='lazygit'
alias ldk='lazydocker'
alias dbui='nvim -c "DBUI"'
alias oil='nvim -c "Oil"'
alias ccal='ncal -y'
alias pbcopy='xclip -sel c'
alias pbpaste='xclip -sel c -o'
alias nr='newsraft'
alias cr='ENABLE_LSP_TOOL=true claude -r'
alias claude='ENABLE_LSP_TOOL=true claude'

function gdiff() {
  branch=${1:-main}
  [[ $branch -ne main ]] && shift
  git diff -w $(git merge-base @ $branch) --stat -p "$@"
}

# usage: pn [client | api | domain] command
function pn() {
  if [[ $# -eq 0 ]]; then
    pnpm
    return
  fi

  case "$1" in
    cl | client)
      shift
      pnpm -F client "$@"
      return
      ;;
    a | api)
      shift
      pnpm -F api "$@"
      return
      ;;
    d | domain)
      shift
      pnpm -F domain "$@"
      return
      ;;

    dev)
      fuser -k 3000/tcp 8000/tcp 2>/dev/null
      pnpm dev "$@"
      return
      ;;

    start-cc-dev)
      mkdir rules/
      ln -s ~/dev/datum-monorepo/rules/ rules/
      ln -s ~/dev/datum-monorepo/sgconfig.yml sgconfig.yml
      ln -s ~/dev/datum-monorepo/.nvim.lua .nvim.lua
      ln -s ~/dev/datum-monorepo/.mcp.json .mcp.json
      ln -s ~/dev/datum-monorepo/.claude/CLAUDE.md .claude/
      ln -s ~/dev/datum-monorepo/.claude/settings.local.json .claude/
      ln -s ~/dev/datum-monorepo/.claude/commands/ .claude/
      pn i
      pn d build
      pn codegen
      return
      ;;
  esac

  pnpm "$@"
}

. "$HOME/.cargo/env"

export FZF_DEFAULT_OPTS="--layout=reverse"
### endenvs

source $ZSH/oh-my-zsh.sh

# Edit commands using vi bindings -- better than `set -o vi`
bindkey -v

function y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}

# For fzf
source /usr/share/doc/fzf/examples/key-bindings.zsh
source /usr/share/doc/fzf/examples/completion.zsh

function __tmux_fzf_autocomplete__() {
  tmux capture-pane -pS -100000 \
    | awk 'BEGIN { RS = "[ \t\n]" } length($0) > 4 && !seen[$0]++' \
    | fzf --no-sort --exact +i --tac --layout reverse --height 20
}

function __tmux_fzf_autocomplete_widget__() {
  LBUFFER+="$(__tmux_fzf_autocomplete__)"
  zle redisplay
}

zle -N __tmux_fzf_autocomplete_widget__
bindkey '^n' __tmux_fzf_autocomplete_widget__

# Automatically create a new session
tmux has-session -t main 2> /dev/null || tmux new-session -d -s main

eval "$(zoxide init zsh)"
eval "$(starship init zsh)"
